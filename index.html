<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiFi Audio Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-card: #161616;
            --accent: #00e676;
            --danger: #ff4444;
            --text: #ffffff;
            --text-dim: #888888;
        }

        body {
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            overflow: hidden;
            max-width: 950px;
            width: 95%;
        }

        .player-section {
            padding: 40px 30px;
            width: 420px;
            text-align: center;
            border-right: 1px solid #222;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .playlist-section {
            padding: 30px;
            flex-grow: 1;
            width: 300px;
            display: flex;
            flex-direction: column;
        }

        #file-input { display: none; }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .upload-btn {
            background-color: var(--accent);
            color: #000;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 10px;
            transition: 0.2s;
        }

        .clear-btn {
            background-color: var(--danger);
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 10px;
            transition: 0.2s;
        }

        #album-art {
            width: 220px;
            height: 220px;
            margin: 0 auto 20px auto;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            display: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
        }

        #file-name {
            font-size: 1.1rem;
            color: var(--accent);
            margin-bottom: 5px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #artist-name {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 20px;
            font-weight: 400;
            height: 1.2em;
        }

        audio { width: 100%; filter: invert(1); }

        .nav-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .nav-btn {
            background: #222;
            border: none;
            color: var(--text);
            padding: 10px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 9px;
            text-transform: uppercase;
            transition: 0.2s;
            min-width: 85px;
        }

        .nav-btn:hover { background: #333; color: var(--accent); }
        .nav-btn.active-mode { color: var(--accent); border: 1px solid var(--accent); }

        .playlist-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #222;
            padding-bottom: 15px;
        }

        .playlist-header {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: bold;
        }

        .playlist-items {
            overflow-y: auto;
            max-height: 400px;
            scrollbar-width: thin;
        }

        .playlist-item {
            font-size: 0.85rem;
            padding: 10px;
            cursor: pointer;
            color: var(--text-dim);
            border-radius: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .playlist-item:hover { background: #222; color: var(--text); }
        .playlist-item.active { color: var(--accent); background: #1a1a1a; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="player-section">
            <div style="color: var(--text-dim); font-size: 10px; margin-bottom: 25px; font-weight: bold; letter-spacing: 2px; text-transform: uppercase;">
                HiFi Audio Player
            </div>

            <div id="album-art"></div>
            <div id="file-name">No track selected</div>
            <div id="artist-name"></div>

            <audio id="player" controls></audio>

            <div class="nav-controls">
                <button class="nav-btn" onclick="shufflePlaylist()">Random</button>
                <button class="nav-btn" onclick="prevTrack()">Back</button>
                <button class="nav-btn" onclick="nextTrack()">Next</button>
                <button class="nav-btn" id="repeat-btn" onclick="toggleRepeat()">Repeat: OFF</button>
            </div>
        </div>

        <div class="playlist-section">
            <div class="playlist-header-container">
                <div class="playlist-header">Playlist Queue</div>
                <div class="btn-group">
                    <label for="file-input" class="upload-btn">Add Files</label>
                    <button class="clear-btn" onclick="clearPlaylist()">Clear</button>
                    <input type="file" id="file-input" accept=".flac,.wav,.mp3,.m4a" multiple>
                </div>
            </div>
            
            <div class="playlist-items" id="playlist"></div>
        </div>
    </div>

    <script>
        const player = document.getElementById('player');
        const fileInput = document.getElementById('file-input');
        const fileNameDisp = document.getElementById('file-name');
        const artistNameDisp = document.getElementById('artist-name');
        const albumArt = document.getElementById('album-art');
        const playlistContainer = document.getElementById('playlist');
        const repeatBtn = document.getElementById('repeat-btn');

        let playlist = [];
        let currentIndex = 0;
        let repeatMode = 'off';

        window.onload = () => {
            player.volume = 0.05;
            localStorage.setItem('my_player_settings', JSON.stringify({theme: 'dark', lang: 'en', volume: 0.05}));
        };

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                const startIndex = playlist.length;
                files.forEach(file => {
                    playlist.push({
                        file: file,
                        displayName: cleanFileName(file.name),
                        artist: "Loading..."
                    });
                });
                renderPlaylist();
                files.forEach((file, i) => updateMetadataInList(file, startIndex + i));
                if (player.paused && !player.src) playTrack(startIndex);
            }
        });

        function cleanFileName(name) {
            return name.substring(0, name.lastIndexOf('.')) || name;
        }

        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            playlist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = `playlist-item ${index === currentIndex ? 'active' : ''}`;
                div.textContent = `${index + 1}. ${item.displayName}`;
                div.onclick = () => playTrack(index);
                playlistContainer.appendChild(div);
            });
        }

        function playTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            currentIndex = index;
            const item = playlist[index];
            fileNameDisp.textContent = item.displayName;
            artistNameDisp.textContent = item.artist;
            player.src = URL.createObjectURL(item.file);
            renderPlaylist();
            loadMetadata(item.file, index);
            player.play();
        }

        function updateMetadataInList(file, index) {
            jsmediatags.read(file, {
                onSuccess: function(tag) {
                    if (tag.tags.title) playlist[index].displayName = tag.tags.title;
                    if (tag.tags.artist) playlist[index].artist = tag.tags.artist;
                    renderPlaylist();
                }
            });
        }

        function loadMetadata(file, index) {
            albumArt.style.display = 'none';
            jsmediatags.read(file, {
                onSuccess: function(tag) {
                    if (tag.tags.title) fileNameDisp.textContent = tag.tags.title;
                    if (tag.tags.artist) artistNameDisp.textContent = tag.tags.artist;
                    else artistNameDisp.textContent = "Unknown Artist";
                    const data = tag.tags.picture;
                    if (data) {
                        let base64String = "";
                        for (let i = 0; i < data.data.length; i++) {
                            base64String += String.fromCharCode(data.data[i]);
                        }
                        const base64 = "data:" + data.format + ";base64," + window.btoa(base64String);
                        albumArt.style.backgroundImage = `url(${base64})`;
                        albumArt.style.display = 'block';
                    }
                }
            });
        }

        function clearPlaylist() {
            playlist = [];
            currentIndex = 0;
            player.pause();
            player.src = "";
            fileNameDisp.textContent = "No track selected";
            artistNameDisp.textContent = "";
            albumArt.style.display = 'none';
            renderPlaylist();
        }

        function toggleRepeat() {
            if (repeatMode === 'off') {
                repeatMode = 'one';
                repeatBtn.textContent = 'Repeat: ONE';
                repeatBtn.classList.add('active-mode');
            } else if (repeatMode === 'one') {
                repeatMode = 'all';
                repeatBtn.textContent = 'Repeat: ALL';
                repeatBtn.classList.add('active-mode');
            } else {
                repeatMode = 'off';
                repeatBtn.textContent = 'Repeat: OFF';
                repeatBtn.classList.remove('active-mode');
            }
        }

        function shufflePlaylist() {
            if (playlist.length <= 1) return;
            for (let i = playlist.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
            }
            playTrack(0);
        }

        // --- CORRECTION LOGIQUE NEXT/BACK AVEC REPEAT ONE ---
        function nextTrack() {
            if (repeatMode === 'one') {
                playTrack(currentIndex); // Rejoue le même
            } else if (currentIndex + 1 < playlist.length) {
                playTrack(currentIndex + 1);
            } else if (repeatMode === 'all' && playlist.length > 0) {
                playTrack(0);
            }
        }

        function prevTrack() {
            if (repeatMode === 'one') {
                playTrack(currentIndex); // Rejoue le même
            } else if (currentIndex - 1 >= 0) {
                playTrack(currentIndex - 1);
            }
        }

        player.onended = () => nextTrack();
    </script>
</body>
</html>
